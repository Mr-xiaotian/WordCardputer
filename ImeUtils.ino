struct RomajiMap
{
    const char *romaji;
    const char *hira; // 平假名
    const char *kata; // 片假名
};

static const RomajiMap ROMAJI_TABLE[] = {

    // --- 清音 ---
    {"a", "あ", "ア"},  {"i", "い", "イ"},  {"u", "う", "ウ"},  {"e", "え", "エ"},  {"o", "お", "オ"},
    {"ka", "か", "カ"}, {"ki", "き", "キ"}, {"ku", "く", "ク"}, {"ke", "け", "ケ"}, {"ko", "こ", "コ"},
    {"sa", "さ", "サ"}, {"si", "し", "シ"}, {"su", "す", "ス"}, {"se", "せ", "セ"}, {"so", "そ", "ソ"},
    {"ta", "た", "タ"}, {"ti", "ち", "チ"}, {"tu", "つ", "ツ"}, {"te", "て", "テ"}, {"to", "と", "ト"},
    {"na", "な", "ナ"}, {"ni", "に", "ニ"}, {"nu", "ぬ", "ヌ"}, {"ne", "ね", "ネ"}, {"no", "の", "ノ"},
    {"ha", "は", "ハ"}, {"hi", "ひ", "ヒ"}, {"hu", "ふ", "フ"}, {"he", "へ", "ヘ"}, {"ho", "ほ", "ホ"},
    {"ma", "ま", "マ"}, {"mi", "み", "ミ"}, {"mu", "む", "ム"}, {"me", "め", "メ"}, {"mo", "も", "モ"},
    {"ya", "や", "ヤ"}, {"yu", "ゆ", "ユ"}, {"yo", "よ", "ヨ"},
    {"ra", "ら", "ラ"}, {"ri", "り", "リ"}, {"ru", "る", "ル"}, {"re", "れ", "レ"}, {"ro", "ろ", "ロ"},
    {"wa", "わ", "ワ"}, {"wo", "を", "ヲ"}, {"n", "ん", "ン"},

    // --- 浊音 ---
    {"ga", "が", "ガ"}, {"gi", "ぎ", "ギ"}, {"gu", "ぐ", "グ"}, {"ge", "げ", "ゲ"}, {"go", "ご", "ゴ"},
    {"za", "ざ", "ザ"}, {"zi", "じ", "ジ"}, {"zu", "ず", "ズ"}, {"ze", "ぜ", "ゼ"}, {"zo", "ぞ", "ゾ"},
    {"da", "だ", "ダ"}, {"di", "ぢ", "ヂ"}, {"du", "づ", "ヅ"}, {"de", "で", "デ"}, {"do", "ど", "ド"},
    {"ba", "ば", "バ"}, {"bi", "び", "ビ"}, {"bu", "ぶ", "ブ"}, {"be", "べ", "ベ"}, {"bo", "ぼ", "ボ"},

    // --- 半浊音 ---
    {"pa", "ぱ", "パ"}, {"pi", "ぴ", "ピ"}, {"pu", "ぷ", "プ"}, {"pe", "ぺ", "ペ"}, {"po", "ぽ", "ポ"},
    
    // --- 拗音 --- 
    {"kya", "きゃ", "キャ"}, {"kyu", "きゅ", "キュ"}, {"kyo", "きょ", "キョ"}, 
    {"sha", "しゃ", "シャ"}, {"shu", "しゅ", "シュ"}, {"sho", "しょ", "ショ"}, 
    {"cha", "ちゃ", "チャ"}, {"chu", "ちゅ", "チュ"}, {"cho", "ちょ", "チョ"},
    {"nya", "にゃ", "ニャ"}, {"nyu", "にゅ", "ニュ"}, {"nyo", "にょ", "ニョ"}, 
    {"hya", "ひゃ", "ヒャ"}, {"hyu", "ひゅ", "ヒュ"}, {"hyo", "ひょ", "ヒョ"},
    {"mya", "みゃ", "ミャ"}, {"myu", "みゅ", "ミュ"}, {"myo", "みょ", "ミョ"},
    {"rya", "りゃ", "リャ"}, {"ryu", "りゅ", "リュ"}, {"ryo", "りょ", "リョ"},
    {"ja", "じゃ", "ジャ"},  {"ju", "じゅ", "ジュ"},  {"jo", "じょ", "ジョ"},
    {"bya", "びゃ", "ビャ"}, {"byu", "びゅ", "ビュ"}, {"byo", "びょ", "ビョ"},
    {"pya", "ぴゃ", "ピャ"}, {"pyu", "ぴゅ", "ピュ"}, {"pyo", "ぴょ", "ピョ"},

    // --- 长音 ---
    {"-", "", "ー"},
};

static const int ROMAJI_TABLE_SIZE = sizeof(ROMAJI_TABLE) / sizeof(ROMAJI_TABLE[0]);

// ---------- 罗马音转换表 ----------
// 根据当前 romajiBuffer 返回“候选假名”
// 仅当 buffer 完全匹配某一条 romaji 时才返回假名,否则返回 ""。
// 不修改 buffer,本函数只是“看一眼”。
String matchRomaji(const String &buffer, bool useKatakana)
{
    if (buffer.length() == 0)
        return "";

    for (int i = 0; i < ROMAJI_TABLE_SIZE; ++i)
    {
        if (buffer.equalsIgnoreCase(ROMAJI_TABLE[i].romaji))
        {
            String candidate = useKatakana ? ROMAJI_TABLE[i].kata : ROMAJI_TABLE[i].hira;
            return String(candidate);
        }
    }
    return "";
}

// 删除 UTF-8 字符串末尾的一个“完整字符”
void removeLastUTF8Char(String &s)
{
    int len = s.length();
    if (len == 0)
        return;

    // UTF-8 末尾字节判断（10xxxxxx = continuation）
    int i = len - 1;
    while (i >= 0 && ((s[i] & 0b11000000) == 0b10000000))
    {
        i--;
    }

    // i 现在停在字符的起始字节
    s.remove(i);
}
